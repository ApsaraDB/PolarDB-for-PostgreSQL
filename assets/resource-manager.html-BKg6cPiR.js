import{_ as i,c as u,a,b as n,e as k,w as e,r as o,o as d,d as t}from"./app-HZE5kvva.js";const m={},g={class:"table-of-contents"};function b(l,s){const r=o("Badge"),c=o("ArticleInfo"),p=o("router-link");return d(),u("div",null,[s[5]||(s[5]=a("h1",{id:"resource-manager",tabindex:"-1"},[a("a",{class:"header-anchor",href:"#resource-manager"},[a("span",null,"Resource Manager")])],-1)),n(r,{type:"tip",text:"V11 / v1.1.1-",vertical:"top"}),n(c,{frontmatter:l.$frontmatter},null,8,["frontmatter"]),a("nav",g,[a("ul",null,[a("li",null,[n(p,{to:"#背景"},{default:e(()=>s[0]||(s[0]=[t("背景")])),_:1})]),a("li",null,[n(p,{to:"#目标"},{default:e(()=>s[1]||(s[1]=[t("目标")])),_:1})]),a("li",null,[n(p,{to:"#内存限制原理"},{default:e(()=>s[2]||(s[2]=[t("内存限制原理")])),_:1}),a("ul",null,[a("li",null,[n(p,{to:"#内存限制方式"},{default:e(()=>s[3]||(s[3]=[t("内存限制方式")])),_:1})]),a("li",null,[n(p,{to:"#内存限制效果"},{default:e(()=>s[4]||(s[4]=[t("内存限制效果")])),_:1})])])])])]),s[6]||(s[6]=k(`<h2 id="背景" tabindex="-1"><a class="header-anchor" href="#背景"><span>背景</span></a></h2><p>PolarDB for PostgreSQL 的内存可以分为以下三部分：</p><ul><li>共享内存</li><li>进程间动态共享内存</li><li>进程私有内存</li></ul><p>进程间动态共享内存和进程私有内存是 <strong>动态分配</strong> 的，其使用量随着实例承载的业务运行情况而不断变化。过多使用动态内存，可能会导致内存使用量超过操作系统限制，触发内核内存限制机制，造成实例进程异常退出，实例重启，引发实例不可用的问题。</p><p>进程私有内存 MemoryContext 管理的内存可以分为两部分：</p><ul><li>工作计算区域内存：业务运行所需的内存，此部分内存会影响业务的正常运行；</li><li>Cache 内存：数据库会把部分内部元数据存放在进程内，此部分内存只会影响数据库性能；</li></ul><h2 id="目标" tabindex="-1"><a class="header-anchor" href="#目标"><span>目标</span></a></h2><p>为了解决以上问题，PolarDB for PostgreSQL 增加了 <strong>Resource Manager</strong> 资源限制机制，能够在实例运行期间，周期性检测资源使用情况。对于超过资源限制阈值的进程，强制进行资源限制，降低实例不可用的风险。</p><p>Resource Manager 主要的限制资源有：</p><ul><li>内存</li><li>CPU</li><li>I/O</li></ul><p>当前仅支持对内存资源进行限制。</p><h2 id="内存限制原理" tabindex="-1"><a class="header-anchor" href="#内存限制原理"><span>内存限制原理</span></a></h2><p>内存限制依赖 Cgroup，如果不存在 Cgroup，则无法有效进行资源限制。Resource Manager 作为 PolarDB for PostgreSQL 一个后台辅助进程，周期性读取 Cgroup 的内存使用数据作为内存限制的依据。当发现存在进程超过内存限制阈值后，会读取内核的用户进程内存记账，按照内存大小排序，依次对内存使用量超过阈值的进程发送中断进程信号（SIGTERM）或取消操作信号（SIGINT）。</p><h3 id="内存限制方式" tabindex="-1"><a class="header-anchor" href="#内存限制方式"><span>内存限制方式</span></a></h3><p>Resource Manager 守护进程会随着实例启动而建立，同时对 RW、RO 以及 Standby 节点起作用。可以通过修改参数改变 Resource Manager 的行为。</p><ul><li><code>enable_resource_manager</code>：是否启动 Resource Manager，取值为 <code>on</code> / <code>off</code>，默认值为 <code>on</code></li><li><code>stat_interval</code>：资源使用量周期检测的间隔，单位为毫秒，取值范围为 <code>10</code>-<code>10000</code>，默认值为 <code>500</code></li><li><code>total_mem_limit_rate</code>：限制实例内存使用的百分比，当实例内存使用超过该百分比后，开始强制对内存资源进行限制，默认值为 <code>95</code></li><li><code>total_mem_limit_remain_size</code>：实例内存预留值，当实例空闲内存小于预留值后，开始强制对内存资源进行限制，单位为 kB，取值范围为 <code>131072</code>-<code>MAX_KILOBYTES</code>（整型数值最大值），默认值为 <code>524288</code></li><li><code>mem_release_policy</code>：内存资源限制的策略 <ul><li><code>none</code>：无动作</li><li><code>default</code>：缺省策略（默认值），优先中断空闲进程，然后中断活跃进程</li><li><code>cancel_query</code>：中断活跃进程</li><li><code>terminate_idle_backend</code>：中断空闲进程</li><li><code>terminate_any_backend</code>：中断所有进程</li><li><code>terminate_random_backend</code>：中断随机进程</li></ul></li></ul><h3 id="内存限制效果" tabindex="-1"><a class="header-anchor" href="#内存限制效果"><span>内存限制效果</span></a></h3><div class="language-log" data-highlighter="prismjs" data-ext="log"><pre><code><span class="line"><span class="token date number">2022-11-28</span> <span class="token time number">14:07:56.929</span> UTC <span class="token punctuation">[</span><span class="token number">18179</span><span class="token punctuation">]</span> <span class="token property">LOG:</span>  <span class="token punctuation">[</span>polar_resource_manager<span class="token punctuation">]</span> terminate process <span class="token number">13461</span> release memory <span class="token number">65434123</span> bytes</span>
<span class="line"><span class="token date number">2022-11-28</span> <span class="token time number">14:08:17.143</span> UTC <span class="token punctuation">[</span><span class="token number">35472</span><span class="token punctuation">]</span> <span class="token level error important">FATAL</span><span class="token operator">:</span>  terminating connection due to out of memory</span>
<span class="line"><span class="token date number">2022-11-28</span> <span class="token time number">14:08:17.143</span> UTC <span class="token punctuation">[</span><span class="token number">35472</span><span class="token punctuation">]</span> <span class="token property">BACKTRACE:</span></span>
<span class="line">        <span class="token property">postgres:</span> <span class="token property">primary:</span> postgres postgres <span class="token punctuation">[</span>local<span class="token punctuation">]</span> idle<span class="token operator">(</span>ProcessInterrupts<span class="token operator">+</span><span class="token number">0x34c</span><span class="token operator">)</span> <span class="token punctuation">[</span><span class="token number">0xae5fda</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token property">postgres:</span> <span class="token property">primary:</span> postgres postgres <span class="token punctuation">[</span>local<span class="token punctuation">]</span> idle<span class="token operator">(</span>ProcessClientReadInterrupt<span class="token operator">+</span><span class="token number">0x3a</span><span class="token operator">)</span> <span class="token punctuation">[</span><span class="token number">0xae1ad6</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token property">postgres:</span> <span class="token property">primary:</span> postgres postgres <span class="token punctuation">[</span>local<span class="token punctuation">]</span> idle<span class="token operator">(</span>secure_read<span class="token operator">+</span><span class="token number">0x209</span><span class="token operator">)</span> <span class="token punctuation">[</span><span class="token number">0x8c9070</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token property">postgres:</span> <span class="token property">primary:</span> postgres postgres <span class="token punctuation">[</span>local<span class="token punctuation">]</span> idle<span class="token operator">(</span><span class="token operator">)</span> <span class="token punctuation">[</span><span class="token number">0x8d4565</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token property">postgres:</span> <span class="token property">primary:</span> postgres postgres <span class="token punctuation">[</span>local<span class="token punctuation">]</span> idle<span class="token operator">(</span>pq_getbyte<span class="token operator">+</span><span class="token number">0x30</span><span class="token operator">)</span> <span class="token punctuation">[</span><span class="token number">0x8d4613</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token property">postgres:</span> <span class="token property">primary:</span> postgres postgres <span class="token punctuation">[</span>local<span class="token punctuation">]</span> idle<span class="token operator">(</span><span class="token operator">)</span> <span class="token punctuation">[</span><span class="token number">0xae1861</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token property">postgres:</span> <span class="token property">primary:</span> postgres postgres <span class="token punctuation">[</span>local<span class="token punctuation">]</span> idle<span class="token operator">(</span><span class="token operator">)</span> <span class="token punctuation">[</span><span class="token number">0xae1a83</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token property">postgres:</span> <span class="token property">primary:</span> postgres postgres <span class="token punctuation">[</span>local<span class="token punctuation">]</span> idle<span class="token operator">(</span>PostgresMain<span class="token operator">+</span><span class="token number">0x8df</span><span class="token operator">)</span> <span class="token punctuation">[</span><span class="token number">0xae7949</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token property">postgres:</span> <span class="token property">primary:</span> postgres postgres <span class="token punctuation">[</span>local<span class="token punctuation">]</span> idle<span class="token operator">(</span><span class="token operator">)</span> <span class="token punctuation">[</span><span class="token number">0x9f4c4c</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token property">postgres:</span> <span class="token property">primary:</span> postgres postgres <span class="token punctuation">[</span>local<span class="token punctuation">]</span> idle<span class="token operator">(</span><span class="token operator">)</span> <span class="token punctuation">[</span><span class="token number">0x9f440c</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token property">postgres:</span> <span class="token property">primary:</span> postgres postgres <span class="token punctuation">[</span>local<span class="token punctuation">]</span> idle<span class="token operator">(</span><span class="token operator">)</span> <span class="token punctuation">[</span><span class="token number">0x9ef963</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token property">postgres:</span> <span class="token property">primary:</span> postgres postgres <span class="token punctuation">[</span>local<span class="token punctuation">]</span> idle<span class="token operator">(</span>PostmasterMain<span class="token operator">+</span><span class="token number">0x1321</span><span class="token operator">)</span> <span class="token punctuation">[</span><span class="token number">0x9ef18a</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token property">postgres:</span> <span class="token property">primary:</span> postgres postgres <span class="token punctuation">[</span>local<span class="token punctuation">]</span> idle<span class="token operator">(</span><span class="token operator">)</span> <span class="token punctuation">[</span><span class="token number">0x8dc1f6</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token file-path string">/lib64/libc.so.6</span><span class="token operator">(</span>__libc_start_main<span class="token operator">+</span><span class="token number">0xf5</span><span class="token operator">)</span> <span class="token punctuation">[</span><span class="token number">0x7f888afff445</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token property">postgres:</span> <span class="token property">primary:</span> postgres postgres <span class="token punctuation">[</span>local<span class="token punctuation">]</span> idle<span class="token operator">(</span><span class="token operator">)</span> <span class="token punctuation">[</span><span class="token number">0x49d209</span><span class="token punctuation">]</span></span>
<span class="line"></span></code></pre></div>`,18))])}const f=i(m,[["render",b]]),h=JSON.parse('{"path":"/zh/features/availability/resource-manager.html","title":"Resource Manager","lang":"zh-CN","frontmatter":{"author":"学有","date":"2022/11/25","minute":20},"headers":[{"level":2,"title":"背景","slug":"背景","link":"#背景","children":[]},{"level":2,"title":"目标","slug":"目标","link":"#目标","children":[]},{"level":2,"title":"内存限制原理","slug":"内存限制原理","link":"#内存限制原理","children":[{"level":3,"title":"内存限制方式","slug":"内存限制方式","link":"#内存限制方式","children":[]},{"level":3,"title":"内存限制效果","slug":"内存限制效果","link":"#内存限制效果","children":[]}]}],"git":{"updatedTime":1760793941000,"contributors":[{"name":"aCoder2013","username":"aCoder2013","email":"7877752+aCoder2013@users.noreply.github.com","commits":1,"url":"https://github.com/aCoder2013"}],"changelog":[{"hash":"6fcfdc2993a4b32b3c1c8119b43c3545d6ab9654","time":1760793941000,"email":"7877752+aCoder2013@users.noreply.github.com","author":"acoder2014","message":"fix: typo in arch-overview.md (#608)"}]},"filePathRelative":"zh/features/availability/resource-manager.md"}');export{f as comp,h as data};
