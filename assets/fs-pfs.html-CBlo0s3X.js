import{_ as d,c as m,a as s,b as t,e as b,w as p,d as n,r as o,o as h}from"./app-HZE5kvva.js";const f={},g={class:"table-of-contents"};function v(r,a){const i=o("ArticleInfo"),e=o("router-link"),u=o("CodeTabs"),k=o("RouteLink");return h(),m("div",null,[a[12]||(a[12]=s("h1",{id:"格式化并挂载-pfs",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#格式化并挂载-pfs"},[s("span",null,"格式化并挂载 PFS")])],-1)),t(i,{frontmatter:r.$frontmatter},null,8,["frontmatter"]),a[13]||(a[13]=s("p",null,"PolarDB File System，简称 PFS 或 PolarFS，是由阿里云自主研发的高性能类 POSIX 的用户态分布式文件系统，服务于阿里云数据库 PolarDB 产品。使用 PFS 对共享存储进行格式化并挂载后，能够保证一个计算节点对共享存储的写入能够立刻对另一个计算节点可见。",-1)),s("nav",g,[s("ul",null,[s("li",null,[t(e,{to:"#pfs-编译安装"},{default:p(()=>a[0]||(a[0]=[n("PFS 编译安装")])),_:1})]),s("li",null,[t(e,{to:"#块设备重命名"},{default:p(()=>a[1]||(a[1]=[n("块设备重命名")])),_:1})]),s("li",null,[t(e,{to:"#块设备格式化"},{default:p(()=>a[2]||(a[2]=[n("块设备格式化")])),_:1})]),s("li",null,[t(e,{to:"#pfs-文件系统挂载"},{default:p(()=>a[3]||(a[3]=[n("PFS 文件系统挂载")])),_:1})]),s("li",null,[t(e,{to:"#在-pfs-上编译部署-polardb"},{default:p(()=>a[4]||(a[4]=[n("在 PFS 上编译部署 PolarDB")])),_:1})])])]),a[14]||(a[14]=s("h2",{id:"pfs-编译安装",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#pfs-编译安装"},[s("span",null,"PFS 编译安装")])],-1)),a[15]||(a[15]=s("p",null,[n("推荐使用 PolarDB-PG 的 "),s("a",{href:"https://hub.docker.com/r/polardb/polardb_pg_binary/tags",target:"_blank",rel:"noopener noreferrer"},"可执行文件镜像"),n("，其中已经包含了编译完毕的 PFS 工具，无需手动编译安装。通过以下命令进入容器即可：")],-1)),t(u,{id:"17",data:[{id:"DockerHub"},{id:"阿里云 ACR"}]},{title0:p(({value:l,isActive:c})=>a[5]||(a[5]=[n("DockerHub")])),title1:p(({value:l,isActive:c})=>a[6]||(a[6]=[n("阿里云 ACR")])),tab0:p(({value:l,isActive:c})=>a[7]||(a[7]=[s("div",{class:"language-bash","data-highlighter":"prismjs","data-ext":"sh"},[s("pre",null,[s("code",null,[s("span",{class:"line"},[s("span",{class:"token function"},"docker"),n(" pull polardb/polardb_pg_binary:15")]),n(`
`),s("span",{class:"line"},[s("span",{class:"token function"},"docker"),n(" run "),s("span",{class:"token parameter variable"},"-it"),n(),s("span",{class:"token punctuation"},"\\")]),n(`
`),s("span",{class:"line"},[n("    "),s("span",{class:"token parameter variable"},"--network"),s("span",{class:"token operator"},"="),n("host "),s("span",{class:"token punctuation"},"\\")]),n(`
`),s("span",{class:"line"},[n("    --cap-add"),s("span",{class:"token operator"},"="),n("SYS_PTRACE "),s("span",{class:"token punctuation"},"\\")]),n(`
`),s("span",{class:"line"},[n("    "),s("span",{class:"token parameter variable"},"--privileged"),s("span",{class:"token operator"},"="),n("true "),s("span",{class:"token punctuation"},"\\")]),n(`
`),s("span",{class:"line"},[n("    "),s("span",{class:"token parameter variable"},"--name"),n(" polardb_pg "),s("span",{class:"token punctuation"},"\\")]),n(`
`),s("span",{class:"line"},[n("    --shm-size"),s("span",{class:"token operator"},"="),n("512m "),s("span",{class:"token punctuation"},"\\")]),n(`
`),s("span",{class:"line"},[n("    polardb/polardb_pg_binary:15 "),s("span",{class:"token punctuation"},"\\")]),n(`
`),s("span",{class:"line"},[n("    "),s("span",{class:"token function"},"bash")]),n(`
`),s("span",{class:"line"})])])],-1)])),tab1:p(({value:l,isActive:c})=>a[8]||(a[8]=[s("div",{class:"language-bash","data-highlighter":"prismjs","data-ext":"sh"},[s("pre",null,[s("code",null,[s("span",{class:"line"},[s("span",{class:"token function"},"docker"),n(" pull registry.cn-hangzhou.aliyuncs.com/polardb_pg/polardb_pg_binary:15")]),n(`
`),s("span",{class:"line"},[s("span",{class:"token function"},"docker"),n(" run "),s("span",{class:"token parameter variable"},"-it"),n(),s("span",{class:"token punctuation"},"\\")]),n(`
`),s("span",{class:"line"},[n("    --cap-add"),s("span",{class:"token operator"},"="),n("SYS_PTRACE "),s("span",{class:"token punctuation"},"\\")]),n(`
`),s("span",{class:"line"},[n("    "),s("span",{class:"token parameter variable"},"--privileged"),s("span",{class:"token operator"},"="),n("true "),s("span",{class:"token punctuation"},"\\")]),n(`
`),s("span",{class:"line"},[n("    "),s("span",{class:"token parameter variable"},"--name"),n(" polardb_pg "),s("span",{class:"token punctuation"},"\\")]),n(`
`),s("span",{class:"line"},[n("    --shm-size"),s("span",{class:"token operator"},"="),n("512m "),s("span",{class:"token punctuation"},"\\")]),n(`
`),s("span",{class:"line"},[n("    registry.cn-hangzhou.aliyuncs.com/polardb_pg/polardb_pg_binary:15 "),s("span",{class:"token punctuation"},"\\")]),n(`
`),s("span",{class:"line"},[n("    "),s("span",{class:"token function"},"bash")]),n(`
`),s("span",{class:"line"})])])],-1)])),_:1}),a[16]||(a[16]=b(`<p>PFS 的手动编译安装方式请参考 PFS 的 <a href="https://github.com/ApsaraDB/polardb-file-system/blob/master/Readme-CN.md" target="_blank" rel="noopener noreferrer">README</a>，此处不再赘述。</p><h2 id="块设备重命名" tabindex="-1"><a class="header-anchor" href="#块设备重命名"><span>块设备重命名</span></a></h2><p>PFS 仅支持访问 <strong>以特定字符开头的块设备</strong>（详情可见 <a href="https://github.com/ApsaraDB/PolarDB-FileSystem" target="_blank" rel="noopener noreferrer">PolarDB File System</a> 源代码的 <a href="https://github.com/ApsaraDB/PolarDB-FileSystem/blob/master/src/pfs_core/pfs_api.h" target="_blank" rel="noopener noreferrer"><code>src/pfs_core/pfs_api.h</code></a> 文件）：</p><div class="language-c" data-highlighter="prismjs" data-ext="c"><pre><code><span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">PFS_PATH_ISVALID</span><span class="token expression"><span class="token punctuation">(</span>path<span class="token punctuation">)</span>                                  </span><span class="token punctuation">\\</span></span>
<span class="line">    <span class="token expression"><span class="token punctuation">(</span>path <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span>                                            </span><span class="token punctuation">\\</span></span>
<span class="line">     <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> </span><span class="token char">&#39;/&#39;</span> <span class="token expression"><span class="token operator">&amp;&amp;</span> <span class="token function">isdigit</span><span class="token punctuation">(</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> </span><span class="token char">&#39;.&#39;</span>  <span class="token punctuation">\\</span></span>
<span class="line">      <span class="token expression"><span class="token operator">||</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> </span><span class="token string">&quot;/pangu-&quot;</span><span class="token expression"><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>                       </span><span class="token punctuation">\\</span></span>
<span class="line">      <span class="token expression"><span class="token operator">||</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> </span><span class="token string">&quot;/sd&quot;</span><span class="token expression"><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>                           </span><span class="token punctuation">\\</span></span>
<span class="line">      <span class="token expression"><span class="token operator">||</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> </span><span class="token string">&quot;/sf&quot;</span><span class="token expression"><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>                           </span><span class="token punctuation">\\</span></span>
<span class="line">      <span class="token expression"><span class="token operator">||</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> </span><span class="token string">&quot;/vd&quot;</span><span class="token expression"><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>                           </span><span class="token punctuation">\\</span></span>
<span class="line">      <span class="token expression"><span class="token operator">||</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> </span><span class="token string">&quot;/nvme&quot;</span><span class="token expression"><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>                         </span><span class="token punctuation">\\</span></span>
<span class="line">      <span class="token expression"><span class="token operator">||</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> </span><span class="token string">&quot;/loop&quot;</span><span class="token expression"><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>                         </span><span class="token punctuation">\\</span></span>
<span class="line">      <span class="token expression"><span class="token operator">||</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> </span><span class="token string">&quot;/mapper_&quot;</span><span class="token expression"><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span></span>
<span class="line"></span></code></pre></div><p>因此，为了保证能够顺畅完成后续流程，我们建议在所有访问块设备的节点上使用相同的软链接访问共享块设备。例如，在 NBD 服务端主机上，使用新的块设备名 <code>/dev/nvme1n1</code> 软链接到共享存储块设备的原有名称 <code>/dev/vdb</code> 上：</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token function">sudo</span> <span class="token function">ln</span> <span class="token parameter variable">-s</span> /dev/vdb /dev/nvme1n1</span>
<span class="line"></span></code></pre></div><p>在 NBD 客户端主机上，使用同样的块设备名 <code>/dev/nvme1n1</code> 软链到共享存储块设备的原有名称 <code>/dev/nbd0</code> 上：</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token function">sudo</span> <span class="token function">ln</span> <span class="token parameter variable">-s</span> /dev/nbd0 /dev/nvme1n1</span>
<span class="line"></span></code></pre></div><p>这样便可以在服务端和客户端两台主机上使用相同的块设备名 <code>/dev/nvme1n1</code> 访问同一个块设备。</p><h2 id="块设备格式化" tabindex="-1"><a class="header-anchor" href="#块设备格式化"><span>块设备格式化</span></a></h2><p>使用 <strong>任意一台主机</strong>，在共享存储块设备上格式化 PFS 分布式文件系统：</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token function">sudo</span> pfs <span class="token parameter variable">-C</span> disk <span class="token function">mkfs</span> nvme1n1</span>
<span class="line"></span></code></pre></div><h2 id="pfs-文件系统挂载" tabindex="-1"><a class="header-anchor" href="#pfs-文件系统挂载"><span>PFS 文件系统挂载</span></a></h2><p>在能够访问共享存储的 <strong>所有主机节点</strong> 上分别启动 PFS 守护进程，挂载 PFS 文件系统：</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token function">sudo</span> /usr/local/polarstore/pfsd/bin/start_pfsd.sh <span class="token parameter variable">-p</span> nvme1n1 <span class="token parameter variable">-w</span> <span class="token number">4</span></span>
<span class="line"></span></code></pre></div><hr><h2 id="在-pfs-上编译部署-polardb" tabindex="-1"><a class="header-anchor" href="#在-pfs-上编译部署-polardb"><span>在 PFS 上编译部署 PolarDB</span></a></h2>`,17)),s("p",null,[a[10]||(a[10]=n("参阅 ")),t(k,{to:"/zh/deploying/db-pfs.html"},{default:p(()=>a[9]||(a[9]=[n("PolarDB 编译部署：PFS 文件系统")])),_:1}),a[11]||(a[11]=n("。"))])])}const x=d(f,[["render",v]]),S=JSON.parse('{"path":"/zh/deploying/fs-pfs.html","title":"格式化并挂载 PFS","lang":"zh-CN","frontmatter":{"author":"棠羽","date":"2025/01/15","minute":15},"headers":[{"level":2,"title":"PFS 编译安装","slug":"pfs-编译安装","link":"#pfs-编译安装","children":[]},{"level":2,"title":"块设备重命名","slug":"块设备重命名","link":"#块设备重命名","children":[]},{"level":2,"title":"块设备格式化","slug":"块设备格式化","link":"#块设备格式化","children":[]},{"level":2,"title":"PFS 文件系统挂载","slug":"pfs-文件系统挂载","link":"#pfs-文件系统挂载","children":[]},{"level":2,"title":"在 PFS 上编译部署 PolarDB","slug":"在-pfs-上编译部署-polardb","link":"#在-pfs-上编译部署-polardb","children":[]}],"git":{"updatedTime":1760793941000,"contributors":[{"name":"aCoder2013","username":"aCoder2013","email":"7877752+aCoder2013@users.noreply.github.com","commits":1,"url":"https://github.com/aCoder2013"}],"changelog":[{"hash":"6fcfdc2993a4b32b3c1c8119b43c3545d6ab9654","time":1760793941000,"email":"7877752+aCoder2013@users.noreply.github.com","author":"acoder2014","message":"fix: typo in arch-overview.md (#608)"}]},"filePathRelative":"zh/deploying/fs-pfs.md"}');export{x as comp,S as data};
