import{_ as m,c as b,a as s,b as e,e as r,w as p,d as n,r as t,o as w}from"./app-HZE5kvva.js";const y={},h={class:"table-of-contents"};function g(u,a){const i=t("ArticleInfo"),o=t("router-link"),d=t("CodeTabs"),k=t("RouteLink");return w(),b("div",null,[a[17]||(a[17]=s("h1",{id:"tpc-h-测试",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#tpc-h-测试"},[s("span",null,"TPC-H 测试")])],-1)),e(i,{frontmatter:u.$frontmatter},null,8,["frontmatter"]),a[18]||(a[18]=s("p",null,"本文将引导您对 PolarDB for PostgreSQL 进行 TPC-H 测试。",-1)),s("nav",h,[s("ul",null,[s("li",null,[e(o,{to:"#背景"},{default:p(()=>a[0]||(a[0]=[n("背景")])),_:1})]),s("li",null,[e(o,{to:"#测试准备"},{default:p(()=>a[1]||(a[1]=[n("测试准备")])),_:1}),s("ul",null,[s("li",null,[e(o,{to:"#部署-polardb-pg"},{default:p(()=>a[2]||(a[2]=[n("部署 PolarDB-PG")])),_:1})]),s("li",null,[e(o,{to:"#生成-tpc-h-测试数据集"},{default:p(()=>a[3]||(a[3]=[n("生成 TPC-H 测试数据集")])),_:1})])])]),s("li",null,[e(o,{to:"#执行-postgresql-单机并行执行"},{default:p(()=>a[4]||(a[4]=[n("执行 PostgreSQL 单机并行执行")])),_:1})]),s("li",null,[e(o,{to:"#执行-epq-单机并行执行"},{default:p(()=>a[5]||(a[5]=[n("执行 ePQ 单机并行执行")])),_:1})]),s("li",null,[e(o,{to:"#执行-epq-跨机并行执行"},{default:p(()=>a[6]||(a[6]=[n("执行 ePQ 跨机并行执行")])),_:1})])])]),a[19]||(a[19]=r('<h2 id="背景" tabindex="-1"><a class="header-anchor" href="#背景"><span>背景</span></a></h2><p><a href="https://www.tpc.org/tpch/default5.asp" target="_blank" rel="noopener noreferrer">TPC-H</a> 是专门测试数据库分析型场景性能的数据集。</p><h2 id="测试准备" tabindex="-1"><a class="header-anchor" href="#测试准备"><span>测试准备</span></a></h2><h3 id="部署-polardb-pg" tabindex="-1"><a class="header-anchor" href="#部署-polardb-pg"><span>部署 PolarDB-PG</span></a></h3><p>使用 Docker 快速拉起一个单机的 PolarDB for PostgreSQL 集群：</p>',5)),e(d,{id:"26",data:[{id:"DockerHub"},{id:"阿里云 ACR"}]},{title0:p(({value:l,isActive:c})=>a[7]||(a[7]=[n("DockerHub")])),title1:p(({value:l,isActive:c})=>a[8]||(a[8]=[n("阿里云 ACR")])),tab0:p(({value:l,isActive:c})=>a[9]||(a[9]=[s("div",{class:"language-bash","data-highlighter":"prismjs","data-ext":"sh"},[s("pre",null,[s("code",null,[s("span",{class:"line"},[s("span",{class:"token function"},"docker"),n(" pull polardb/polardb_pg_local_instance:11")]),n(`
`),s("span",{class:"line"},[s("span",{class:"token function"},"docker"),n(" run "),s("span",{class:"token parameter variable"},"-it"),n(),s("span",{class:"token punctuation"},"\\")]),n(`
`),s("span",{class:"line"},[n("    --cap-add"),s("span",{class:"token operator"},"="),n("SYS_PTRACE "),s("span",{class:"token punctuation"},"\\")]),n(`
`),s("span",{class:"line"},[n("    "),s("span",{class:"token parameter variable"},"--privileged"),s("span",{class:"token operator"},"="),n("true "),s("span",{class:"token punctuation"},"\\")]),n(`
`),s("span",{class:"line"},[n("    "),s("span",{class:"token parameter variable"},"--name"),n(" polardb_pg_htap "),s("span",{class:"token punctuation"},"\\")]),n(`
`),s("span",{class:"line"},[n("    --shm-size"),s("span",{class:"token operator"},"="),n("512m "),s("span",{class:"token punctuation"},"\\")]),n(`
`),s("span",{class:"line"},[n("    polardb/polardb_pg_local_instance:11 "),s("span",{class:"token punctuation"},"\\")]),n(`
`),s("span",{class:"line"},[n("    "),s("span",{class:"token function"},"bash")]),n(`
`),s("span",{class:"line"})])])],-1)])),tab1:p(({value:l,isActive:c})=>a[10]||(a[10]=[s("div",{class:"language-bash","data-highlighter":"prismjs","data-ext":"sh"},[s("pre",null,[s("code",null,[s("span",{class:"line"},[s("span",{class:"token function"},"docker"),n(" pull registry.cn-hangzhou.aliyuncs.com/polardb_pg/polardb_pg_local_instance:11")]),n(`
`),s("span",{class:"line"},[s("span",{class:"token function"},"docker"),n(" run "),s("span",{class:"token parameter variable"},"-it"),n(),s("span",{class:"token punctuation"},"\\")]),n(`
`),s("span",{class:"line"},[n("    --cap-add"),s("span",{class:"token operator"},"="),n("SYS_PTRACE "),s("span",{class:"token punctuation"},"\\")]),n(`
`),s("span",{class:"line"},[n("    "),s("span",{class:"token parameter variable"},"--privileged"),s("span",{class:"token operator"},"="),n("true "),s("span",{class:"token punctuation"},"\\")]),n(`
`),s("span",{class:"line"},[n("    "),s("span",{class:"token parameter variable"},"--name"),n(" polardb_pg_htap "),s("span",{class:"token punctuation"},"\\")]),n(`
`),s("span",{class:"line"},[n("    --shm-size"),s("span",{class:"token operator"},"="),n("512m "),s("span",{class:"token punctuation"},"\\")]),n(`
`),s("span",{class:"line"},[n("    registry.cn-hangzhou.aliyuncs.com/polardb_pg/polardb_pg_local_instance:11 "),s("span",{class:"token punctuation"},"\\")]),n(`
`),s("span",{class:"line"},[n("    "),s("span",{class:"token function"},"bash")]),n(`
`),s("span",{class:"line"})])])],-1)])),_:1}),s("p",null,[a[12]||(a[12]=n("或者参考 ")),e(k,{to:"/deploying/deploy.html"},{default:p(()=>a[11]||(a[11]=[n("进阶部署")])),_:1}),a[13]||(a[13]=n(" 部署一个基于共享存储的 PolarDB for PostgreSQL 集群。"))]),a[20]||(a[20]=r(`<h3 id="生成-tpc-h-测试数据集" tabindex="-1"><a class="header-anchor" href="#生成-tpc-h-测试数据集"><span>生成 TPC-H 测试数据集</span></a></h3><p>通过 <a href="https://github.com/ApsaraDB/tpch-dbgen" target="_blank" rel="noopener noreferrer">tpch-dbgen</a> 工具来生成测试数据。</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line">$ <span class="token function">git</span> clone https://github.com/ApsaraDB/tpch-dbgen.git</span>
<span class="line">$ <span class="token builtin class-name">cd</span> tpch-dbgen</span>
<span class="line">$ ./build.sh <span class="token parameter variable">--help</span></span>
<span class="line"></span>
<span class="line">  <span class="token number">1</span><span class="token punctuation">)</span> Use default configuration to build</span>
<span class="line">  ./build.sh</span>
<span class="line">  <span class="token number">2</span><span class="token punctuation">)</span> Use limited configuration to build</span>
<span class="line">  ./build.sh <span class="token parameter variable">--user</span><span class="token operator">=</span>postgres <span class="token parameter variable">--db</span><span class="token operator">=</span>postgres <span class="token parameter variable">--host</span><span class="token operator">=</span>localhost <span class="token parameter variable">--port</span><span class="token operator">=</span><span class="token number">5432</span> <span class="token parameter variable">--scale</span><span class="token operator">=</span><span class="token number">1</span></span>
<span class="line">  <span class="token number">3</span><span class="token punctuation">)</span> Run the <span class="token builtin class-name">test</span> <span class="token keyword">case</span></span>
<span class="line">  ./build.sh <span class="token parameter variable">--run</span></span>
<span class="line">  <span class="token number">4</span><span class="token punctuation">)</span> Run the target <span class="token builtin class-name">test</span> <span class="token keyword">case</span></span>
<span class="line">  ./build.sh <span class="token parameter variable">--run</span><span class="token operator">=</span><span class="token number">3</span>. run the 3rd case.</span>
<span class="line">  <span class="token number">5</span><span class="token punctuation">)</span> Run the target <span class="token builtin class-name">test</span> <span class="token keyword">case</span> with option</span>
<span class="line">  ./build.sh <span class="token parameter variable">--run</span> <span class="token parameter variable">--option</span><span class="token operator">=</span><span class="token string">&quot;set polar_enable_px = on;&quot;</span></span>
<span class="line">  <span class="token number">6</span><span class="token punctuation">)</span> Clean the <span class="token builtin class-name">test</span> data. This step will drop the database or tables, remove csv</span>
<span class="line">  and tbl files</span>
<span class="line">  ./build.sh <span class="token parameter variable">--clean</span></span>
<span class="line">  <span class="token number">7</span><span class="token punctuation">)</span> Quick build TPC-H with 100MB scale of data</span>
<span class="line">  ./build.sh <span class="token parameter variable">--scale</span><span class="token operator">=</span><span class="token number">0.1</span></span>
<span class="line"></span></code></pre></div><p>通过设置不同的参数，可以定制化地创建不同规模的 TPC-H 数据集。<code>build.sh</code> 脚本中各个参数的含义如下：</p><ul><li><code>--user</code>：数据库用户名</li><li><code>--db</code>：数据库名</li><li><code>--host</code>：数据库主机地址</li><li><code>--port</code>：数据库服务端口</li><li><code>--run</code>：执行所有 TPC-H 查询，或执行某条特定的 TPC-H 查询</li><li><code>--option</code>：额外指定 GUC 参数</li><li><code>--scale</code>：生成 TPC-H 数据集的规模，单位为 GB</li></ul><p>该脚本没有提供输入数据库密码的参数，需要通过设置 <code>PGPASSWORD</code> 为数据库用户的数据库密码来完成认证：</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token builtin class-name">export</span> <span class="token assign-left variable">PGPASSWORD</span><span class="token operator">=</span><span class="token operator">&lt;</span>your password<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre></div><p>生成并导入 100MB 规模的 TPC-H 数据：</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line">./build.sh <span class="token parameter variable">--scale</span><span class="token operator">=</span><span class="token number">0.1</span></span>
<span class="line"></span></code></pre></div><p>生成并导入 1GB 规模的 TPC-H 数据：</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line">./build.sh</span>
<span class="line"></span></code></pre></div><h2 id="执行-postgresql-单机并行执行" tabindex="-1"><a class="header-anchor" href="#执行-postgresql-单机并行执行"><span>执行 PostgreSQL 单机并行执行</span></a></h2><p>以 TPC-H 的 Q18 为例，执行 PostgreSQL 的单机并行查询，并观测查询速度。</p><p>在 <code>tpch-dbgen/</code> 目录下通过 <code>psql</code> 连接到数据库：</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token builtin class-name">cd</span> tpch-dbgen</span>
<span class="line">psql</span>
<span class="line"></span></code></pre></div><div class="language-sql" data-highlighter="prismjs" data-ext="sql"><pre><code><span class="line"><span class="token comment">-- 打开计时</span></span>
<span class="line">\\timing <span class="token keyword">on</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 设置单机并行度</span></span>
<span class="line"><span class="token keyword">SET</span> max_parallel_workers_per_gather <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 查看 Q18 的执行计划</span></span>
<span class="line">\\i finals<span class="token operator">/</span><span class="token number">18.</span><span class="token keyword">explain</span><span class="token punctuation">.</span><span class="token keyword">sql</span></span>
<span class="line">                                                                         QUERY <span class="token keyword">PLAN</span></span>
<span class="line"><span class="token comment">------------------------------------------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"> Sort  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">3450834.75</span><span class="token punctuation">.</span><span class="token number">.3450835</span><span class="token number">.42</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">268</span> width<span class="token operator">=</span><span class="token number">81</span><span class="token punctuation">)</span></span>
<span class="line">   Sort <span class="token keyword">Key</span>: orders<span class="token punctuation">.</span>o_totalprice <span class="token keyword">DESC</span><span class="token punctuation">,</span> orders<span class="token punctuation">.</span>o_orderdate</span>
<span class="line">   <span class="token operator">-</span><span class="token operator">&gt;</span>  GroupAggregate  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">3450817.91</span><span class="token punctuation">.</span><span class="token number">.3450823</span><span class="token number">.94</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">268</span> width<span class="token operator">=</span><span class="token number">81</span><span class="token punctuation">)</span></span>
<span class="line">         <span class="token keyword">Group</span> <span class="token keyword">Key</span>: customer<span class="token punctuation">.</span>c_custkey<span class="token punctuation">,</span> orders<span class="token punctuation">.</span>o_orderkey</span>
<span class="line">         <span class="token operator">-</span><span class="token operator">&gt;</span>  Sort  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">3450817.91</span><span class="token punctuation">.</span><span class="token number">.3450818</span><span class="token number">.58</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">268</span> width<span class="token operator">=</span><span class="token number">67</span><span class="token punctuation">)</span></span>
<span class="line">               Sort <span class="token keyword">Key</span>: customer<span class="token punctuation">.</span>c_custkey<span class="token punctuation">,</span> orders<span class="token punctuation">.</span>o_orderkey</span>
<span class="line">               <span class="token operator">-</span><span class="token operator">&gt;</span>  <span class="token keyword">Hash</span> <span class="token keyword">Join</span>  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">1501454.20</span><span class="token punctuation">.</span><span class="token number">.3450807</span><span class="token number">.10</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">268</span> width<span class="token operator">=</span><span class="token number">67</span><span class="token punctuation">)</span></span>
<span class="line">                     <span class="token keyword">Hash</span> Cond: <span class="token punctuation">(</span>lineitem<span class="token punctuation">.</span>l_orderkey <span class="token operator">=</span> orders<span class="token punctuation">.</span>o_orderkey<span class="token punctuation">)</span></span>
<span class="line">                     <span class="token operator">-</span><span class="token operator">&gt;</span>  Seq Scan <span class="token keyword">on</span> lineitem  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">.</span><span class="token number">.1724402</span><span class="token number">.52</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">59986052</span> width<span class="token operator">=</span><span class="token number">22</span><span class="token punctuation">)</span></span>
<span class="line">                     <span class="token operator">-</span><span class="token operator">&gt;</span>  <span class="token keyword">Hash</span>  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">1501453.37</span><span class="token punctuation">.</span><span class="token number">.1501453</span><span class="token number">.37</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">67</span> width<span class="token operator">=</span><span class="token number">53</span><span class="token punctuation">)</span></span>
<span class="line">                           <span class="token operator">-</span><span class="token operator">&gt;</span>  Nested <span class="token keyword">Loop</span>  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">1500465.85</span><span class="token punctuation">.</span><span class="token number">.1501453</span><span class="token number">.37</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">67</span> width<span class="token operator">=</span><span class="token number">53</span><span class="token punctuation">)</span></span>
<span class="line">                                 <span class="token operator">-</span><span class="token operator">&gt;</span>  Nested <span class="token keyword">Loop</span>  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">1500465.43</span><span class="token punctuation">.</span><span class="token number">.1501084</span><span class="token number">.65</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">67</span> width<span class="token operator">=</span><span class="token number">34</span><span class="token punctuation">)</span></span>
<span class="line">                                       <span class="token operator">-</span><span class="token operator">&gt;</span>  Finalize GroupAggregate  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">1500464.99</span><span class="token punctuation">.</span><span class="token number">.1500517</span><span class="token number">.66</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">67</span> width<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span></span>
<span class="line">                                             <span class="token keyword">Group</span> <span class="token keyword">Key</span>: lineitem_1<span class="token punctuation">.</span>l_orderkey</span>
<span class="line">                                             Filter: <span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>lineitem_1<span class="token punctuation">.</span>l_quantity<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token string">&#39;314&#39;</span>::<span class="token keyword">numeric</span><span class="token punctuation">)</span></span>
<span class="line">                                             <span class="token operator">-</span><span class="token operator">&gt;</span>  Gather <span class="token keyword">Merge</span>  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">1500464.99</span><span class="token punctuation">.</span><span class="token number">.1500511</span><span class="token number">.66</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">400</span> width<span class="token operator">=</span><span class="token number">36</span><span class="token punctuation">)</span></span>
<span class="line">                                                   Workers Planned: <span class="token number">2</span></span>
<span class="line">                                                   <span class="token operator">-</span><span class="token operator">&gt;</span>  Sort  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">1499464.97</span><span class="token punctuation">.</span><span class="token number">.1499465</span><span class="token number">.47</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">200</span> width<span class="token operator">=</span><span class="token number">36</span><span class="token punctuation">)</span></span>
<span class="line">                                                         Sort <span class="token keyword">Key</span>: lineitem_1<span class="token punctuation">.</span>l_orderkey</span>
<span class="line">                                                         <span class="token operator">-</span><span class="token operator">&gt;</span>  <span class="token keyword">Partial</span> HashAggregate  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">1499454.82</span><span class="token punctuation">.</span><span class="token number">.1499457</span><span class="token number">.32</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">200</span> width<span class="token operator">=</span><span class="token number">36</span><span class="token punctuation">)</span></span>
<span class="line">                                                               <span class="token keyword">Group</span> <span class="token keyword">Key</span>: lineitem_1<span class="token punctuation">.</span>l_orderkey</span>
<span class="line">                                                               <span class="token operator">-</span><span class="token operator">&gt;</span>  Parallel Seq Scan <span class="token keyword">on</span> lineitem lineitem_1  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">.</span><span class="token number">.1374483</span><span class="token number">.88</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">24994188</span> width<span class="token operator">=</span><span class="token number">22</span><span class="token punctuation">)</span></span>
<span class="line">                                       <span class="token operator">-</span><span class="token operator">&gt;</span>  <span class="token keyword">Index</span> Scan <span class="token keyword">using</span> orders_pkey <span class="token keyword">on</span> orders  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">0.43</span><span class="token punctuation">.</span><span class="token number">.8</span><span class="token number">.45</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">1</span> width<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span></span>
<span class="line">                                             <span class="token keyword">Index</span> Cond: <span class="token punctuation">(</span>o_orderkey <span class="token operator">=</span> lineitem_1<span class="token punctuation">.</span>l_orderkey<span class="token punctuation">)</span></span>
<span class="line">                                 <span class="token operator">-</span><span class="token operator">&gt;</span>  <span class="token keyword">Index</span> Scan <span class="token keyword">using</span> customer_pkey <span class="token keyword">on</span> customer  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">0.43</span><span class="token punctuation">.</span><span class="token number">.5</span><span class="token number">.50</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">1</span> width<span class="token operator">=</span><span class="token number">23</span><span class="token punctuation">)</span></span>
<span class="line">                                       <span class="token keyword">Index</span> Cond: <span class="token punctuation">(</span>c_custkey <span class="token operator">=</span> orders<span class="token punctuation">.</span>o_custkey<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">(</span><span class="token number">26</span> <span class="token keyword">rows</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">Time</span>: <span class="token number">3.965</span> ms</span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 执行 Q18</span></span>
<span class="line">\\i finals<span class="token operator">/</span><span class="token number">18.</span><span class="token keyword">sql</span></span>
<span class="line">       c_name       <span class="token operator">|</span> c_custkey <span class="token operator">|</span> o_orderkey <span class="token operator">|</span> o_orderdate <span class="token operator">|</span> o_totalprice <span class="token operator">|</span>  sum</span>
<span class="line"><span class="token comment">--------------------+-----------+------------+-------------+--------------+--------</span></span>
<span class="line"> Customer<span class="token comment">#001287812 |   1287812 |   42290181 | 1997-11-26  |    558289.17 | 318.00</span></span>
<span class="line"> Customer<span class="token comment">#001172513 |   1172513 |   36667107 | 1997-06-06  |    550142.18 | 322.00</span></span>
<span class="line"> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span>
<span class="line"> Customer<span class="token comment">#001288183 |   1288183 |   48943904 | 1996-07-22  |    398081.59 | 325.00</span></span>
<span class="line"> Customer<span class="token comment">#000114613 |    114613 |   59930883 | 1997-05-17  |    394335.49 | 319.00</span></span>
<span class="line"><span class="token punctuation">(</span><span class="token number">84</span> <span class="token keyword">rows</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">Time</span>: <span class="token number">80150.449</span> ms <span class="token punctuation">(</span><span class="token number">01</span>:<span class="token number">20.150</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre></div><h2 id="执行-epq-单机并行执行" tabindex="-1"><a class="header-anchor" href="#执行-epq-单机并行执行"><span>执行 ePQ 单机并行执行</span></a></h2><p>PolarDB for PostgreSQL 提供了弹性跨机并行查询（ePQ）的能力，非常适合进行分析型查询。下面的步骤将引导您可以在一台主机上使用 ePQ 并行执行 TPC-H 查询。</p><p>在 <code>tpch-dbgen/</code> 目录下通过 <code>psql</code> 连接到数据库：</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token builtin class-name">cd</span> tpch-dbgen</span>
<span class="line">psql</span>
<span class="line"></span></code></pre></div><p>首先需要对 TPC-H 产生的八张表设置 ePQ 的最大查询并行度：</p><div class="language-sql" data-highlighter="prismjs" data-ext="sql"><pre><code><span class="line"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> nation <span class="token keyword">SET</span> <span class="token punctuation">(</span>px_workers <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> region <span class="token keyword">SET</span> <span class="token punctuation">(</span>px_workers <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> supplier <span class="token keyword">SET</span> <span class="token punctuation">(</span>px_workers <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> part <span class="token keyword">SET</span> <span class="token punctuation">(</span>px_workers <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> partsupp <span class="token keyword">SET</span> <span class="token punctuation">(</span>px_workers <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> customer <span class="token keyword">SET</span> <span class="token punctuation">(</span>px_workers <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> orders <span class="token keyword">SET</span> <span class="token punctuation">(</span>px_workers <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> lineitem <span class="token keyword">SET</span> <span class="token punctuation">(</span>px_workers <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre></div><p>以 Q18 为例，执行查询：</p><div class="language-sql" data-highlighter="prismjs" data-ext="sql"><pre><code><span class="line"><span class="token comment">-- 打开计时</span></span>
<span class="line">\\timing <span class="token keyword">on</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 打开 ePQ 功能的开关</span></span>
<span class="line"><span class="token keyword">SET</span> polar_enable_px <span class="token operator">=</span> <span class="token keyword">ON</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">-- 设置每个节点的 ePQ 并行度为 1</span></span>
<span class="line"><span class="token keyword">SET</span> polar_px_dop_per_node <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 查看 Q18 的执行计划</span></span>
<span class="line">\\i finals<span class="token operator">/</span><span class="token number">18.</span><span class="token keyword">explain</span><span class="token punctuation">.</span><span class="token keyword">sql</span></span>
<span class="line">                                                                          QUERY <span class="token keyword">PLAN</span></span>
<span class="line"><span class="token comment">---------------------------------------------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"> PX Coordinator <span class="token number">2</span>:<span class="token number">1</span>  <span class="token punctuation">(</span>slice1<span class="token punctuation">;</span> segments: <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">.</span><span class="token number">.257526</span><span class="token number">.21</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">59986052</span> width<span class="token operator">=</span><span class="token number">47</span><span class="token punctuation">)</span></span>
<span class="line">   <span class="token keyword">Merge</span> <span class="token keyword">Key</span>: orders<span class="token punctuation">.</span>o_totalprice<span class="token punctuation">,</span> orders<span class="token punctuation">.</span>o_orderdate</span>
<span class="line">   <span class="token operator">-</span><span class="token operator">&gt;</span>  GroupAggregate  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">.</span><span class="token number">.243457</span><span class="token number">.68</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">29993026</span> width<span class="token operator">=</span><span class="token number">47</span><span class="token punctuation">)</span></span>
<span class="line">         <span class="token keyword">Group</span> <span class="token keyword">Key</span>: orders<span class="token punctuation">.</span>o_totalprice<span class="token punctuation">,</span> orders<span class="token punctuation">.</span>o_orderdate<span class="token punctuation">,</span> customer<span class="token punctuation">.</span>c_name<span class="token punctuation">,</span> customer<span class="token punctuation">.</span>c_custkey<span class="token punctuation">,</span> orders<span class="token punctuation">.</span>o_orderkey</span>
<span class="line">         <span class="token operator">-</span><span class="token operator">&gt;</span>  Sort  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">.</span><span class="token number">.241257</span><span class="token number">.18</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">29993026</span> width<span class="token operator">=</span><span class="token number">47</span><span class="token punctuation">)</span></span>
<span class="line">               Sort <span class="token keyword">Key</span>: orders<span class="token punctuation">.</span>o_totalprice <span class="token keyword">DESC</span><span class="token punctuation">,</span> orders<span class="token punctuation">.</span>o_orderdate<span class="token punctuation">,</span> customer<span class="token punctuation">.</span>c_name<span class="token punctuation">,</span> customer<span class="token punctuation">.</span>c_custkey<span class="token punctuation">,</span> orders<span class="token punctuation">.</span>o_orderkey</span>
<span class="line">               <span class="token operator">-</span><span class="token operator">&gt;</span>  <span class="token keyword">Hash</span> <span class="token keyword">Join</span>  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">.</span><span class="token number">.42729</span><span class="token number">.99</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">29993026</span> width<span class="token operator">=</span><span class="token number">47</span><span class="token punctuation">)</span></span>
<span class="line">                     <span class="token keyword">Hash</span> Cond: <span class="token punctuation">(</span>orders<span class="token punctuation">.</span>o_orderkey <span class="token operator">=</span> lineitem_1<span class="token punctuation">.</span>l_orderkey<span class="token punctuation">)</span></span>
<span class="line">                     <span class="token operator">-</span><span class="token operator">&gt;</span>  PX <span class="token keyword">Hash</span> <span class="token number">2</span>:<span class="token number">2</span>  <span class="token punctuation">(</span>slice2<span class="token punctuation">;</span> segments: <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">.</span><span class="token number">.15959</span><span class="token number">.71</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">7500000</span> width<span class="token operator">=</span><span class="token number">39</span><span class="token punctuation">)</span></span>
<span class="line">                           <span class="token keyword">Hash</span> <span class="token keyword">Key</span>: orders<span class="token punctuation">.</span>o_orderkey</span>
<span class="line">                           <span class="token operator">-</span><span class="token operator">&gt;</span>  <span class="token keyword">Hash</span> <span class="token keyword">Join</span>  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">.</span><span class="token number">.15044</span><span class="token number">.19</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">7500000</span> width<span class="token operator">=</span><span class="token number">39</span><span class="token punctuation">)</span></span>
<span class="line">                                 <span class="token keyword">Hash</span> Cond: <span class="token punctuation">(</span>orders<span class="token punctuation">.</span>o_custkey <span class="token operator">=</span> customer<span class="token punctuation">.</span>c_custkey<span class="token punctuation">)</span></span>
<span class="line">                                 <span class="token operator">-</span><span class="token operator">&gt;</span>  PX <span class="token keyword">Hash</span> <span class="token number">2</span>:<span class="token number">2</span>  <span class="token punctuation">(</span>slice3<span class="token punctuation">;</span> segments: <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">.</span><span class="token number">.11561</span><span class="token number">.51</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">7500000</span> width<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span></span>
<span class="line">                                       <span class="token keyword">Hash</span> <span class="token keyword">Key</span>: orders<span class="token punctuation">.</span>o_custkey</span>
<span class="line">                                       <span class="token operator">-</span><span class="token operator">&gt;</span>  <span class="token keyword">Hash</span> Semi <span class="token keyword">Join</span>  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">.</span><span class="token number">.11092</span><span class="token number">.01</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">7500000</span> width<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span></span>
<span class="line">                                             <span class="token keyword">Hash</span> Cond: <span class="token punctuation">(</span>orders<span class="token punctuation">.</span>o_orderkey <span class="token operator">=</span> lineitem<span class="token punctuation">.</span>l_orderkey<span class="token punctuation">)</span></span>
<span class="line">                                             <span class="token operator">-</span><span class="token operator">&gt;</span>  <span class="token keyword">Partial</span> Seq Scan <span class="token keyword">on</span> orders  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">.</span><span class="token number">.1132</span><span class="token number">.25</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">7500000</span> width<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span></span>
<span class="line">                                             <span class="token operator">-</span><span class="token operator">&gt;</span>  <span class="token keyword">Hash</span>  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">7760.84</span><span class="token punctuation">.</span><span class="token number">.7760</span><span class="token number">.84</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">400</span> width<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span></span>
<span class="line">                                                   <span class="token operator">-</span><span class="token operator">&gt;</span>  PX Broadcast <span class="token number">2</span>:<span class="token number">2</span>  <span class="token punctuation">(</span>slice4<span class="token punctuation">;</span> segments: <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">.</span><span class="token number">.7760</span><span class="token number">.84</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">400</span> width<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span></span>
<span class="line">                                                         <span class="token operator">-</span><span class="token operator">&gt;</span>  Result  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">.</span><span class="token number">.7760</span><span class="token number">.80</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">200</span> width<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span></span>
<span class="line">                                                               Filter: <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>lineitem<span class="token punctuation">.</span>l_quantity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token string">&#39;314&#39;</span>::<span class="token keyword">numeric</span><span class="token punctuation">)</span></span>
<span class="line">                                                               <span class="token operator">-</span><span class="token operator">&gt;</span>  Finalize HashAggregate  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">.</span><span class="token number">.7760</span><span class="token number">.78</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">500</span> width<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">)</span></span>
<span class="line">                                                                     <span class="token keyword">Group</span> <span class="token keyword">Key</span>: lineitem<span class="token punctuation">.</span>l_orderkey</span>
<span class="line">                                                                     <span class="token operator">-</span><span class="token operator">&gt;</span>  PX <span class="token keyword">Hash</span> <span class="token number">2</span>:<span class="token number">2</span>  <span class="token punctuation">(</span>slice5<span class="token punctuation">;</span> segments: <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">.</span><span class="token number">.7760</span><span class="token number">.72</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">500</span> width<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">)</span></span>
<span class="line">                                                                           <span class="token keyword">Hash</span> <span class="token keyword">Key</span>: lineitem<span class="token punctuation">.</span>l_orderkey</span>
<span class="line">                                                                           <span class="token operator">-</span><span class="token operator">&gt;</span>  <span class="token keyword">Partial</span> HashAggregate  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">.</span><span class="token number">.7760</span><span class="token number">.70</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">500</span> width<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">)</span></span>
<span class="line">                                                                                 <span class="token keyword">Group</span> <span class="token keyword">Key</span>: lineitem<span class="token punctuation">.</span>l_orderkey</span>
<span class="line">                                                                                 <span class="token operator">-</span><span class="token operator">&gt;</span>  <span class="token keyword">Partial</span> Seq Scan <span class="token keyword">on</span> lineitem  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">.</span><span class="token number">.3350</span><span class="token number">.82</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">29993026</span> width<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">)</span></span>
<span class="line">                                 <span class="token operator">-</span><span class="token operator">&gt;</span>  <span class="token keyword">Hash</span>  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">597.51</span><span class="token punctuation">.</span><span class="token number">.597</span><span class="token number">.51</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">749979</span> width<span class="token operator">=</span><span class="token number">23</span><span class="token punctuation">)</span></span>
<span class="line">                                       <span class="token operator">-</span><span class="token operator">&gt;</span>  PX <span class="token keyword">Hash</span> <span class="token number">2</span>:<span class="token number">2</span>  <span class="token punctuation">(</span>slice6<span class="token punctuation">;</span> segments: <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">.</span><span class="token number">.597</span><span class="token number">.51</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">749979</span> width<span class="token operator">=</span><span class="token number">23</span><span class="token punctuation">)</span></span>
<span class="line">                                             <span class="token keyword">Hash</span> <span class="token keyword">Key</span>: customer<span class="token punctuation">.</span>c_custkey</span>
<span class="line">                                             <span class="token operator">-</span><span class="token operator">&gt;</span>  <span class="token keyword">Partial</span> Seq Scan <span class="token keyword">on</span> customer  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">.</span><span class="token number">.511</span><span class="token number">.44</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">749979</span> width<span class="token operator">=</span><span class="token number">23</span><span class="token punctuation">)</span></span>
<span class="line">                     <span class="token operator">-</span><span class="token operator">&gt;</span>  <span class="token keyword">Hash</span>  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">5146.80</span><span class="token punctuation">.</span><span class="token number">.5146</span><span class="token number">.80</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">29993026</span> width<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">)</span></span>
<span class="line">                           <span class="token operator">-</span><span class="token operator">&gt;</span>  PX <span class="token keyword">Hash</span> <span class="token number">2</span>:<span class="token number">2</span>  <span class="token punctuation">(</span>slice7<span class="token punctuation">;</span> segments: <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">.</span><span class="token number">.5146</span><span class="token number">.80</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">29993026</span> width<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">)</span></span>
<span class="line">                                 <span class="token keyword">Hash</span> <span class="token keyword">Key</span>: lineitem_1<span class="token punctuation">.</span>l_orderkey</span>
<span class="line">                                 <span class="token operator">-</span><span class="token operator">&gt;</span>  <span class="token keyword">Partial</span> Seq Scan <span class="token keyword">on</span> lineitem lineitem_1  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">.</span><span class="token number">.3350</span><span class="token number">.82</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">29993026</span> width<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">)</span></span>
<span class="line"> Optimizer: PolarDB PX Optimizer</span>
<span class="line"><span class="token punctuation">(</span><span class="token number">37</span> <span class="token keyword">rows</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">Time</span>: <span class="token number">216.672</span> ms</span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 执行 Q18</span></span>
<span class="line">       c_name       <span class="token operator">|</span> c_custkey <span class="token operator">|</span> o_orderkey <span class="token operator">|</span> o_orderdate <span class="token operator">|</span> o_totalprice <span class="token operator">|</span>  sum</span>
<span class="line"><span class="token comment">--------------------+-----------+------------+-------------+--------------+--------</span></span>
<span class="line"> Customer<span class="token comment">#001287812 |   1287812 |   42290181 | 1997-11-26  |    558289.17 | 318.00</span></span>
<span class="line"> Customer<span class="token comment">#001172513 |   1172513 |   36667107 | 1997-06-06  |    550142.18 | 322.00</span></span>
<span class="line"> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span>
<span class="line"> Customer<span class="token comment">#001288183 |   1288183 |   48943904 | 1996-07-22  |    398081.59 | 325.00</span></span>
<span class="line"> Customer<span class="token comment">#000114613 |    114613 |   59930883 | 1997-05-17  |    394335.49 | 319.00</span></span>
<span class="line"><span class="token punctuation">(</span><span class="token number">84</span> <span class="token keyword">rows</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">Time</span>: <span class="token number">59113.965</span> ms <span class="token punctuation">(</span><span class="token number">00</span>:<span class="token number">59.114</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre></div><p>可以看到比 PostgreSQL 的单机并行执行的时间略短。加大 ePQ 功能的节点并行度，查询性能将会有更明显的提升：</p><div class="language-sql" data-highlighter="prismjs" data-ext="sql"><pre><code><span class="line"><span class="token keyword">SET</span> polar_px_dop_per_node <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></span>
<span class="line">\\i finals<span class="token operator">/</span><span class="token number">18.</span><span class="token keyword">sql</span></span>
<span class="line">       c_name       <span class="token operator">|</span> c_custkey <span class="token operator">|</span> o_orderkey <span class="token operator">|</span> o_orderdate <span class="token operator">|</span> o_totalprice <span class="token operator">|</span>  sum</span>
<span class="line"><span class="token comment">--------------------+-----------+------------+-------------+--------------+--------</span></span>
<span class="line"> Customer<span class="token comment">#001287812 |   1287812 |   42290181 | 1997-11-26  |    558289.17 | 318.00</span></span>
<span class="line"> Customer<span class="token comment">#001172513 |   1172513 |   36667107 | 1997-06-06  |    550142.18 | 322.00</span></span>
<span class="line"> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span>
<span class="line"> Customer<span class="token comment">#001288183 |   1288183 |   48943904 | 1996-07-22  |    398081.59 | 325.00</span></span>
<span class="line"> Customer<span class="token comment">#000114613 |    114613 |   59930883 | 1997-05-17  |    394335.49 | 319.00</span></span>
<span class="line"><span class="token punctuation">(</span><span class="token number">84</span> <span class="token keyword">rows</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">Time</span>: <span class="token number">42400.500</span> ms <span class="token punctuation">(</span><span class="token number">00</span>:<span class="token number">42.401</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">SET</span> polar_px_dop_per_node <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span></span>
<span class="line">\\i finals<span class="token operator">/</span><span class="token number">18.</span><span class="token keyword">sql</span></span>
<span class="line"></span>
<span class="line">       c_name       <span class="token operator">|</span> c_custkey <span class="token operator">|</span> o_orderkey <span class="token operator">|</span> o_orderdate <span class="token operator">|</span> o_totalprice <span class="token operator">|</span>  sum</span>
<span class="line"><span class="token comment">--------------------+-----------+------------+-------------+--------------+--------</span></span>
<span class="line"> Customer<span class="token comment">#001287812 |   1287812 |   42290181 | 1997-11-26  |    558289.17 | 318.00</span></span>
<span class="line"> Customer<span class="token comment">#001172513 |   1172513 |   36667107 | 1997-06-06  |    550142.18 | 322.00</span></span>
<span class="line"> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span>
<span class="line"> Customer<span class="token comment">#001288183 |   1288183 |   48943904 | 1996-07-22  |    398081.59 | 325.00</span></span>
<span class="line"> Customer<span class="token comment">#000114613 |    114613 |   59930883 | 1997-05-17  |    394335.49 | 319.00</span></span>
<span class="line"><span class="token punctuation">(</span><span class="token number">84</span> <span class="token keyword">rows</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">Time</span>: <span class="token number">19892.603</span> ms <span class="token punctuation">(</span><span class="token number">00</span>:<span class="token number">19.893</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">SET</span> polar_px_dop_per_node <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span></span>
<span class="line">\\i finals<span class="token operator">/</span><span class="token number">18.</span><span class="token keyword">sql</span></span>
<span class="line">       c_name       <span class="token operator">|</span> c_custkey <span class="token operator">|</span> o_orderkey <span class="token operator">|</span> o_orderdate <span class="token operator">|</span> o_totalprice <span class="token operator">|</span>  sum</span>
<span class="line"><span class="token comment">--------------------+-----------+------------+-------------+--------------+--------</span></span>
<span class="line"> Customer<span class="token comment">#001287812 |   1287812 |   42290181 | 1997-11-26  |    558289.17 | 318.00</span></span>
<span class="line"> Customer<span class="token comment">#001172513 |   1172513 |   36667107 | 1997-06-06  |    550142.18 | 322.00</span></span>
<span class="line"> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span>
<span class="line"> Customer<span class="token comment">#001288183 |   1288183 |   48943904 | 1996-07-22  |    398081.59 | 325.00</span></span>
<span class="line"> Customer<span class="token comment">#000114613 |    114613 |   59930883 | 1997-05-17  |    394335.49 | 319.00</span></span>
<span class="line"><span class="token punctuation">(</span><span class="token number">84</span> <span class="token keyword">rows</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">Time</span>: <span class="token number">10944.402</span> ms <span class="token punctuation">(</span><span class="token number">00</span>:<span class="token number">10.944</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre></div><blockquote><p>使用 ePQ 执行 Q17 和 Q18 时可能会出现 OOM。需要设置以下参数防止用尽内存：</p><div class="language-sql" data-highlighter="prismjs" data-ext="sql"><pre><code><span class="line"><span class="token keyword">SET</span> polar_px_optimizer_enable_hashagg <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre></div></blockquote><h2 id="执行-epq-跨机并行执行" tabindex="-1"><a class="header-anchor" href="#执行-epq-跨机并行执行"><span>执行 ePQ 跨机并行执行</span></a></h2><p>在上面的例子中，出于简单考虑，PolarDB for PostgreSQL 的多个计算节点被部署在同一台主机上。在这种场景下使用 ePQ 时，由于所有的计算节点都使用了同一台主机的 CPU、内存、I/O 带宽，因此本质上是基于单台主机的并行执行。实际上，PolarDB for PostgreSQL 的计算节点可以被部署在能够共享存储节点的多台机器上。此时使用 ePQ 功能将进行真正的跨机器分布式并行查询，能够充分利用多台机器上的计算资源。</p>`,29)),s("p",null,[a[15]||(a[15]=n("参考 ")),e(k,{to:"/deploying/deploy.html"},{default:p(()=>a[14]||(a[14]=[n("进阶部署")])),_:1}),a[16]||(a[16]=n(" 可以搭建起不同形态的 PolarDB for PostgreSQL 集群。集群搭建成功后，使用 ePQ 的方式与单机 ePQ 完全相同。"))]),a[21]||(a[21]=r(`<blockquote><p>如果遇到如下错误：</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line">psql:queries/q01.analyze.sq1:24: WARNING:  interconnect may encountered a network error, please check your network</span>
<span class="line">DETAIL:  Failed to send packet <span class="token punctuation">(</span>seq <span class="token number">1</span><span class="token punctuation">)</span> to <span class="token number">192.168</span>.1.8:57871 <span class="token punctuation">(</span>pid <span class="token number">17766</span> cid <span class="token number">0</span><span class="token punctuation">)</span> after <span class="token number">100</span> retries.</span>
<span class="line"></span></code></pre></div><p>可以尝试统一修改每台机器的 MTU 为 9000：</p><div class="language-bash" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token function">ifconfig</span> <span class="token operator">&lt;</span>网卡名<span class="token operator">&gt;</span> mtu <span class="token number">9000</span></span>
<span class="line"></span></code></pre></div></blockquote>`,1))])}const P=m(y,[["render",g]]),v=JSON.parse('{"path":"/operation/tpch-test.html","title":"TPC-H 测试","lang":"en-US","frontmatter":{"author":"棠羽","date":"2023/04/12","minute":20},"headers":[{"level":2,"title":"背景","slug":"背景","link":"#背景","children":[]},{"level":2,"title":"测试准备","slug":"测试准备","link":"#测试准备","children":[{"level":3,"title":"部署 PolarDB-PG","slug":"部署-polardb-pg","link":"#部署-polardb-pg","children":[]},{"level":3,"title":"生成 TPC-H 测试数据集","slug":"生成-tpc-h-测试数据集","link":"#生成-tpc-h-测试数据集","children":[]}]},{"level":2,"title":"执行 PostgreSQL 单机并行执行","slug":"执行-postgresql-单机并行执行","link":"#执行-postgresql-单机并行执行","children":[]},{"level":2,"title":"执行 ePQ 单机并行执行","slug":"执行-epq-单机并行执行","link":"#执行-epq-单机并行执行","children":[]},{"level":2,"title":"执行 ePQ 跨机并行执行","slug":"执行-epq-跨机并行执行","link":"#执行-epq-跨机并行执行","children":[]}],"git":{"updatedTime":1760793941000,"contributors":[{"name":"aCoder2013","username":"aCoder2013","email":"7877752+aCoder2013@users.noreply.github.com","commits":1,"url":"https://github.com/aCoder2013"}],"changelog":[{"hash":"6fcfdc2993a4b32b3c1c8119b43c3545d6ab9654","time":1760793941000,"email":"7877752+aCoder2013@users.noreply.github.com","author":"acoder2014","message":"fix: typo in arch-overview.md (#608)"}]},"filePathRelative":"operation/tpch-test.md"}');export{P as comp,v as data};
