-- sanity check of system catalog
SELECT attrelid, attname, attidentity FROM pg_attribute WHERE attidentity NOT IN ('', 'a', 'd');
 attrelid | attname | attidentity 
----------+---------+-------------
(0 rows)

CREATE TABLE itest1 (a int generated by default as identity, b text);
ERROR:  cannot execute CREATE TABLE in a read-only transaction
CREATE TABLE itest2 (a bigint generated always as identity, b text);
ERROR:  cannot execute CREATE TABLE in a read-only transaction
CREATE TABLE itest3 (a smallint generated by default as identity (start with 7 increment by 5), b text);
ERROR:  cannot execute CREATE TABLE in a read-only transaction
ALTER TABLE itest3 ALTER COLUMN a ADD GENERATED ALWAYS AS IDENTITY;  -- error
ERROR:  cannot execute ALTER TABLE in a read-only transaction
SELECT table_name, column_name, column_default, is_nullable, is_identity, identity_generation, identity_start, identity_increment, identity_maximum, identity_minimum, identity_cycle FROM information_schema.columns WHERE table_name LIKE 'itest_' ORDER BY 1, 2;
 table_name | column_name | column_default | is_nullable | is_identity | identity_generation | identity_start | identity_increment |  identity_maximum   | identity_minimum | identity_cycle 
------------+-------------+----------------+-------------+-------------+---------------------+----------------+--------------------+---------------------+------------------+----------------
 itest1     | a           |                | NO          | YES         | BY DEFAULT          | 1              | 1                  | 2147483647          | 1                | NO
 itest1     | b           |                | YES         | NO          |                     |                |                    |                     |                  | NO
 itest2     | a           |                | NO          | YES         | ALWAYS              | 1              | 1                  | 9223372036854775807 | 1                | NO
 itest2     | b           |                | YES         | NO          |                     |                |                    |                     |                  | NO
 itest3     | a           |                | NO          | YES         | BY DEFAULT          | 7              | 5                  | 32767               | 1                | NO
 itest3     | b           |                | YES         | NO          |                     |                |                    |                     |                  | NO
(6 rows)

-- internal sequences should not be shown here
SELECT sequence_name FROM information_schema.sequences WHERE sequence_name LIKE 'itest%';
 sequence_name 
---------------
(0 rows)

SELECT pg_get_serial_sequence('itest1', 'a');
 pg_get_serial_sequence 
------------------------
 public.itest1_a_seq
(1 row)

\d itest1_a_seq
CREATE TABLE itest4 (a int, b text);
ERROR:  cannot execute CREATE TABLE in a read-only transaction
ALTER TABLE itest4 ALTER COLUMN a ADD GENERATED ALWAYS AS IDENTITY;  -- error, requires NOT NULL
ERROR:  cannot execute ALTER TABLE in a read-only transaction
ALTER TABLE itest4 ALTER COLUMN a SET NOT NULL;
ERROR:  cannot execute ALTER TABLE in a read-only transaction
ALTER TABLE itest4 ALTER COLUMN a ADD GENERATED ALWAYS AS IDENTITY;  -- ok
ERROR:  cannot execute ALTER TABLE in a read-only transaction
ALTER TABLE itest4 ALTER COLUMN a DROP NOT NULL;  -- error, disallowed
ERROR:  cannot execute ALTER TABLE in a read-only transaction
ALTER TABLE itest4 ALTER COLUMN a ADD GENERATED ALWAYS AS IDENTITY;  -- error, already set
ERROR:  cannot execute ALTER TABLE in a read-only transaction
ALTER TABLE itest4 ALTER COLUMN b ADD GENERATED ALWAYS AS IDENTITY;  -- error, wrong data type
ERROR:  cannot execute ALTER TABLE in a read-only transaction
-- for later
ALTER TABLE itest4 ALTER COLUMN b SET DEFAULT '';
ERROR:  cannot execute ALTER TABLE in a read-only transaction
-- invalid column type
CREATE TABLE itest_err_1 (a text generated by default as identity);
ERROR:  cannot execute CREATE TABLE in a read-only transaction
-- duplicate identity
CREATE TABLE itest_err_2 (a int generated always as identity generated by default as identity);
ERROR:  cannot execute CREATE TABLE in a read-only transaction
-- cannot have default and identity
CREATE TABLE itest_err_3 (a int default 5 generated by default as identity);
ERROR:  cannot execute CREATE TABLE in a read-only transaction
-- cannot combine serial and identity
CREATE TABLE itest_err_4 (a serial generated by default as identity);
ERROR:  cannot execute CREATE TABLE in a read-only transaction
INSERT INTO itest1 DEFAULT VALUES;
ERROR:  cannot execute INSERT in a read-only transaction
INSERT INTO itest1 DEFAULT VALUES;
ERROR:  cannot execute INSERT in a read-only transaction
INSERT INTO itest2 DEFAULT VALUES;
ERROR:  cannot execute INSERT in a read-only transaction
INSERT INTO itest2 DEFAULT VALUES;
ERROR:  cannot execute INSERT in a read-only transaction
INSERT INTO itest3 DEFAULT VALUES;
ERROR:  cannot execute INSERT in a read-only transaction
INSERT INTO itest3 DEFAULT VALUES;
ERROR:  cannot execute INSERT in a read-only transaction
INSERT INTO itest4 DEFAULT VALUES;
ERROR:  cannot execute INSERT in a read-only transaction
INSERT INTO itest4 DEFAULT VALUES;
ERROR:  cannot execute INSERT in a read-only transaction
SELECT * FROM itest1;
 a | b 
---+---
 1 | 
 2 | 
(2 rows)

SELECT * FROM itest2;
 a | b 
---+---
 1 | 
 2 | 
(2 rows)

SELECT * FROM itest3;
 a  | b 
----+---
  7 | 
 12 | 
(2 rows)

SELECT * FROM itest4;
 a | b 
---+---
 1 | 
 2 | 
(2 rows)

-- VALUES RTEs
INSERT INTO itest3 VALUES (DEFAULT, 'a');
ERROR:  cannot execute INSERT in a read-only transaction
INSERT INTO itest3 VALUES (DEFAULT, 'b'), (DEFAULT, 'c');
ERROR:  cannot execute INSERT in a read-only transaction
SELECT * FROM itest3;
 a  | b 
----+---
  7 | 
 12 | 
 17 | a
 22 | b
 27 | c
(5 rows)

-- OVERRIDING tests
INSERT INTO itest1 VALUES (10, 'xyz');
ERROR:  cannot execute INSERT in a read-only transaction
INSERT INTO itest1 OVERRIDING USER VALUE VALUES (10, 'xyz');
ERROR:  cannot execute INSERT in a read-only transaction
SELECT * FROM itest1;
 a  |  b  
----+-----
  1 | 
  2 | 
 10 | xyz
  3 | xyz
(4 rows)

INSERT INTO itest2 VALUES (10, 'xyz');
ERROR:  cannot insert into column "a"
DETAIL:  Column "a" is an identity column defined as GENERATED ALWAYS.
HINT:  Use OVERRIDING SYSTEM VALUE to override.
INSERT INTO itest2 OVERRIDING SYSTEM VALUE VALUES (10, 'xyz');
ERROR:  cannot execute INSERT in a read-only transaction
SELECT * FROM itest2;
 a  |  b  
----+-----
  1 | 
  2 | 
 10 | xyz
(3 rows)

-- UPDATE tests
UPDATE itest1 SET a = 101 WHERE a = 1;
ERROR:  cannot execute UPDATE in a read-only transaction
UPDATE itest1 SET a = DEFAULT WHERE a = 2;
ERROR:  cannot execute UPDATE in a read-only transaction
SELECT * FROM itest1;
  a  |  b  
-----+-----
  10 | xyz
   3 | xyz
 101 | 
   4 | 
(4 rows)

UPDATE itest2 SET a = 101 WHERE a = 1;
ERROR:  column "a" can only be updated to DEFAULT
DETAIL:  Column "a" is an identity column defined as GENERATED ALWAYS.
UPDATE itest2 SET a = DEFAULT WHERE a = 2;
ERROR:  cannot execute UPDATE in a read-only transaction
SELECT * FROM itest2;
 a  |  b  
----+-----
  1 | 
 10 | xyz
  3 | 
(3 rows)

-- COPY tests
CREATE TABLE itest9 (a int GENERATED ALWAYS AS IDENTITY, b text, c bigint);
ERROR:  cannot execute CREATE TABLE in a read-only transaction
COPY itest9 FROM stdin;
ERROR:  cannot execute COPY FROM in a read-only transaction
COPY itest9 (b, c) FROM stdin;
ERROR:  cannot execute COPY FROM in a read-only transaction
SELECT * FROM itest9 ORDER BY c;
  a  |  b   |  c  
-----+------+-----
 100 | foo  | 200
 101 | bar  | 201
   1 | foo2 | 202
   2 | bar2 | 203
(4 rows)

-- DROP IDENTITY tests
ALTER TABLE itest4 ALTER COLUMN a DROP IDENTITY;
ERROR:  cannot execute ALTER TABLE in a read-only transaction
ALTER TABLE itest4 ALTER COLUMN a DROP IDENTITY;  -- error
ERROR:  cannot execute ALTER TABLE in a read-only transaction
ALTER TABLE itest4 ALTER COLUMN a DROP IDENTITY IF EXISTS;  -- noop
ERROR:  cannot execute ALTER TABLE in a read-only transaction
INSERT INTO itest4 DEFAULT VALUES;  -- fails because NOT NULL is not dropped
ERROR:  cannot execute INSERT in a read-only transaction
ALTER TABLE itest4 ALTER COLUMN a DROP NOT NULL;
ERROR:  cannot execute ALTER TABLE in a read-only transaction
INSERT INTO itest4 DEFAULT VALUES;
ERROR:  cannot execute INSERT in a read-only transaction
SELECT * FROM itest4;
 a | b 
---+---
 1 | 
 2 | 
   | 
(3 rows)

-- check that sequence is removed
SELECT sequence_name FROM itest4_a_seq;
ERROR:  relation "itest4_a_seq" does not exist
LINE 1: SELECT sequence_name FROM itest4_a_seq;
                                  ^
-- test views
CREATE TABLE itest10 (a int generated by default as identity, b text);
ERROR:  cannot execute CREATE TABLE in a read-only transaction
CREATE TABLE itest11 (a int generated always as identity, b text);
ERROR:  cannot execute CREATE TABLE in a read-only transaction
CREATE VIEW itestv10 AS SELECT * FROM itest10;
ERROR:  cannot execute CREATE VIEW in a read-only transaction
CREATE VIEW itestv11 AS SELECT * FROM itest11;
ERROR:  cannot execute CREATE VIEW in a read-only transaction
INSERT INTO itestv10 DEFAULT VALUES;
ERROR:  cannot execute INSERT in a read-only transaction
INSERT INTO itestv10 DEFAULT VALUES;
ERROR:  cannot execute INSERT in a read-only transaction
INSERT INTO itestv11 DEFAULT VALUES;
ERROR:  cannot execute INSERT in a read-only transaction
INSERT INTO itestv11 DEFAULT VALUES;
ERROR:  cannot execute INSERT in a read-only transaction
SELECT * FROM itestv10;
 a | b 
---+---
 1 | 
 2 | 
(2 rows)

SELECT * FROM itestv11;
 a | b 
---+---
 1 | 
 2 | 
(2 rows)

INSERT INTO itestv10 VALUES (10, 'xyz');
ERROR:  cannot execute INSERT in a read-only transaction
INSERT INTO itestv10 OVERRIDING USER VALUE VALUES (11, 'xyz');
ERROR:  cannot execute INSERT in a read-only transaction
SELECT * FROM itestv10;
 a  |  b  
----+-----
  1 | 
  2 | 
 10 | xyz
  3 | xyz
(4 rows)

INSERT INTO itestv11 VALUES (10, 'xyz');
ERROR:  cannot insert into column "a"
DETAIL:  Column "a" is an identity column defined as GENERATED ALWAYS.
HINT:  Use OVERRIDING SYSTEM VALUE to override.
INSERT INTO itestv11 OVERRIDING SYSTEM VALUE VALUES (11, 'xyz');
ERROR:  cannot execute INSERT in a read-only transaction
SELECT * FROM itestv11;
 a  |  b  
----+-----
  1 | 
  2 | 
 11 | xyz
(3 rows)

-- ADD COLUMN
CREATE TABLE itest13 (a int);
ERROR:  cannot execute CREATE TABLE in a read-only transaction
-- add column to empty table
ALTER TABLE itest13 ADD COLUMN b int GENERATED BY DEFAULT AS IDENTITY;
ERROR:  cannot execute ALTER TABLE in a read-only transaction
INSERT INTO itest13 VALUES (1), (2), (3);
ERROR:  cannot execute INSERT in a read-only transaction
-- add column to populated table
ALTER TABLE itest13 ADD COLUMN c int GENERATED BY DEFAULT AS IDENTITY;
ERROR:  cannot execute ALTER TABLE in a read-only transaction
SELECT * FROM itest13;
 a | b | c 
---+---+---
 1 | 1 | 1
 2 | 2 | 2
 3 | 3 | 3
(3 rows)

-- various ALTER COLUMN tests
-- fail, not allowed for identity columns
ALTER TABLE itest1 ALTER COLUMN a SET DEFAULT 1;
ERROR:  cannot execute ALTER TABLE in a read-only transaction
-- fail, not allowed, already has a default
CREATE TABLE itest5 (a serial, b text);
ERROR:  cannot execute CREATE TABLE in a read-only transaction
ALTER TABLE itest5 ALTER COLUMN a ADD GENERATED ALWAYS AS IDENTITY;
ERROR:  cannot execute ALTER TABLE in a read-only transaction
ALTER TABLE itest3 ALTER COLUMN a TYPE int;
ERROR:  cannot execute ALTER TABLE in a read-only transaction
SELECT seqtypid::regtype FROM pg_sequence WHERE seqrelid = 'itest3_a_seq'::regclass;
 seqtypid 
----------
 integer
(1 row)

\d itest3
ALTER TABLE itest3 ALTER COLUMN a TYPE text;  -- error
ERROR:  cannot execute ALTER TABLE in a read-only transaction
-- ALTER COLUMN ... SET
CREATE TABLE itest6 (a int GENERATED ALWAYS AS IDENTITY, b text);
ERROR:  cannot execute CREATE TABLE in a read-only transaction
INSERT INTO itest6 DEFAULT VALUES;
ERROR:  cannot execute INSERT in a read-only transaction
ALTER TABLE itest6 ALTER COLUMN a SET GENERATED BY DEFAULT SET INCREMENT BY 2 SET START WITH 100 RESTART;
ERROR:  cannot execute ALTER TABLE in a read-only transaction
INSERT INTO itest6 DEFAULT VALUES;
ERROR:  cannot execute INSERT in a read-only transaction
INSERT INTO itest6 DEFAULT VALUES;
ERROR:  cannot execute INSERT in a read-only transaction
SELECT * FROM itest6;
  a  | b 
-----+---
   1 | 
 100 | 
 102 | 
(3 rows)

SELECT table_name, column_name, is_identity, identity_generation FROM information_schema.columns WHERE table_name = 'itest6';
 table_name | column_name | is_identity | identity_generation 
------------+-------------+-------------+---------------------
 itest6     | a           | YES         | BY DEFAULT
 itest6     | b           | NO          | 
(2 rows)

ALTER TABLE itest6 ALTER COLUMN b SET INCREMENT BY 2;  -- fail, not identity
ERROR:  cannot execute ALTER TABLE in a read-only transaction
-- prohibited direct modification of sequence
ALTER SEQUENCE itest6_a_seq OWNED BY NONE;
ERROR:  cannot execute ALTER SEQUENCE in a read-only transaction
-- inheritance
CREATE TABLE itest7 (a int GENERATED ALWAYS AS IDENTITY);
ERROR:  cannot execute CREATE TABLE in a read-only transaction
INSERT INTO itest7 DEFAULT VALUES;
ERROR:  cannot execute INSERT in a read-only transaction
SELECT * FROM itest7;
 a 
---
 1
(1 row)

-- identity property is not inherited
CREATE TABLE itest7a (b text) INHERITS (itest7);
ERROR:  cannot execute CREATE TABLE in a read-only transaction
-- make column identity in child table
CREATE TABLE itest7b (a int);
ERROR:  cannot execute CREATE TABLE in a read-only transaction
CREATE TABLE itest7c (a int GENERATED ALWAYS AS IDENTITY) INHERITS (itest7b);
ERROR:  cannot execute CREATE TABLE in a read-only transaction
INSERT INTO itest7c DEFAULT VALUES;
ERROR:  cannot execute INSERT in a read-only transaction
SELECT * FROM itest7c;
 a 
---
 1
(1 row)

CREATE TABLE itest7d (a int not null);
ERROR:  cannot execute CREATE TABLE in a read-only transaction
CREATE TABLE itest7e () INHERITS (itest7d);
ERROR:  cannot execute CREATE TABLE in a read-only transaction
ALTER TABLE itest7d ALTER COLUMN a ADD GENERATED ALWAYS AS IDENTITY;
ERROR:  cannot execute ALTER TABLE in a read-only transaction
ALTER TABLE itest7d ADD COLUMN b int GENERATED ALWAYS AS IDENTITY;  -- error
ERROR:  cannot execute ALTER TABLE in a read-only transaction
SELECT table_name, column_name, is_nullable, is_identity, identity_generation FROM information_schema.columns WHERE table_name LIKE 'itest7%' ORDER BY 1, 2;
 table_name | column_name | is_nullable | is_identity | identity_generation 
------------+-------------+-------------+-------------+---------------------
 itest7     | a           | NO          | YES         | ALWAYS
 itest7a    | a           | NO          | NO          | 
 itest7a    | b           | YES         | NO          | 
 itest7b    | a           | YES         | NO          | 
 itest7c    | a           | NO          | YES         | ALWAYS
 itest7d    | a           | NO          | YES         | ALWAYS
 itest7e    | a           | NO          | NO          | 
(7 rows)

-- These ALTER TABLE variants will not recurse.
ALTER TABLE itest7 ALTER COLUMN a SET GENERATED BY DEFAULT;
ERROR:  cannot execute ALTER TABLE in a read-only transaction
ALTER TABLE itest7 ALTER COLUMN a RESTART;
ERROR:  cannot execute ALTER TABLE in a read-only transaction
ALTER TABLE itest7 ALTER COLUMN a DROP IDENTITY;
ERROR:  cannot execute ALTER TABLE in a read-only transaction
-- privileges
CREATE USER regress_identity_user1;
ERROR:  cannot execute CREATE ROLE in a read-only transaction
CREATE TABLE itest8 (a int GENERATED ALWAYS AS IDENTITY, b text);
ERROR:  cannot execute CREATE TABLE in a read-only transaction
GRANT SELECT, INSERT ON itest8 TO regress_identity_user1;
ERROR:  cannot execute GRANT in a read-only transaction
SET ROLE regress_identity_user1;
INSERT INTO itest8 DEFAULT VALUES;
ERROR:  cannot execute INSERT in a read-only transaction
SELECT * FROM itest8;
 a | b 
---+---
 1 | 
(1 row)

RESET ROLE;
DROP TABLE itest8;
ERROR:  cannot execute DROP TABLE in a read-only transaction
DROP USER regress_identity_user1;
ERROR:  cannot execute DROP ROLE in a read-only transaction
-- typed tables (currently not supported)
CREATE TYPE itest_type AS (f1 integer, f2 text, f3 bigint);
ERROR:  cannot execute CREATE TYPE in a read-only transaction
CREATE TABLE itest12 OF itest_type (f1 WITH OPTIONS GENERATED ALWAYS AS IDENTITY); -- error
ERROR:  cannot execute CREATE TABLE in a read-only transaction
DROP TYPE itest_type CASCADE;
ERROR:  cannot execute DROP TYPE in a read-only transaction
-- table partitions (currently not supported)
CREATE TABLE itest_parent (f1 date NOT NULL, f2 text, f3 bigint) PARTITION BY RANGE (f1);
ERROR:  cannot execute CREATE TABLE in a read-only transaction
CREATE TABLE itest_child PARTITION OF itest_parent (
    f3 WITH OPTIONS GENERATED ALWAYS AS IDENTITY
) FOR VALUES FROM ('2016-07-01') TO ('2016-08-01'); -- error
ERROR:  cannot execute CREATE TABLE in a read-only transaction
DROP TABLE itest_parent;
ERROR:  cannot execute DROP TABLE in a read-only transaction
