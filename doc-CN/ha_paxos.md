PolarDB PostgreSQL（以下简称PolarDB）基于X-Paxos的复制能力，确保节点故障后数据零丢失。X-paxos共识协议由阿里巴巴开发实现，并部署在支持阿里巴巴主要应用和平台的产品系统中。X-Paxos实现跨副本强一致性，并在副本节点故障时保证数据库的高可用性。在出现跨可用区和跨数据中心网络延迟时，X-Paxos能保持高吞吐量和正确性。

PolarDB将X-Paxos与PostgreSQL的流复制功能相结合。X-Paxos负责保持副本状态的一致性，例如其接收和应用的重做日志位置、副本角色和主节点选举等。PostgreSQL的流复制提供WAL传输、接收和持久化功能。

在主节点上，部署一个共识服务，用于与只读节点协商日志同步位置。日志同步位置决定了发送给只读节点的起始WAL记录。只有多数节点收到WAL记录，并且WAL记录被持久化到磁盘上之后，事务才能提交。这个过程称为达成共识。同时，任何与数据相关的持久化操作（写IO）都需要等待相应的WAL记录在副本之间达成共识。对于只读节点，它们的恢复过程仅在达成共识时才应用WAL记录。这可以防止未提交的数据通过只读节点对用户可见。

共识服务维护共识日志。共识日志记录存储WAL条目的位置。主节点根据当前本地WAL位置生成共识日志条目，并将其发送给只读节点。只读节点收到共识日志条目后，在确保共识日志条目对应的WAL记录成功持久化后，将该共识日志条目写入本地磁盘。该共识日志条目在多数节点中持久化后，该日志条目达成共识。主节点通过已经达成共识的共识日志条目中记录的WAL位置，来确定达成共识的WAL位置。

只读节点使用X-Paxos状态机来管理流复制和日志应用。WAL从主节点被拉取到只读节点。当主节点变更后，只读节点根据本地接收的WAL位置，向新的主节点发送WAL请求以获取该位置之后的WAL。当某个只读节点被选为主节点时，它会自动退出恢复，并自动提升为主PostgreSQL实例，为客户端提供读写服务。

PolarDB支持多种X-Paxos角色，如领导者（主节点）、跟随者（只读节点）、记录者（日志节点）等。日志节点和只读节点的区别在于是否存储数据和是否将WAL应用于恢复数据。日志节点仅保留实时WAL记录。日志节点以跟随者的身份进行流复制，但其收到的WAL记录不会被回放。即日志节点不存储数据且不运行恢复。使用日志节点可以使X-Paxos在节点之间实现类似共识，且存储成本更低。

___

 © 阿里巴巴集团控股有限公司 版权所有
