
## HLC、CTS和（分布式）快照隔离

PolarDB PostgreSQL（以下简称PolarDB）实现了一个多核可扩展事务处理系统，并通过基于事务提交时间戳的多版本并发控制（MVCC）来实现分布式事务（即将发布）。传统的PostgreSQL数据库服务根据事务ID（XID）创建快照，根据快照MVCC进行事务隔离。这种事务隔离方式可能会导致多核机器出现扩展瓶颈。具体而言，每个事务开始时，需要通过持有ProcArray锁来为正在ProcArray中运行的所有事务创建快照。同时，获得ProcArray锁也是为了在事务结束时清理事务。在关键路径中频繁使用全局ProcArray锁可能会导致严重的争用。对于Read-Committed（读已提交，RC）隔离，每个快照都是在语句级别生成的。这可能会进一步恶化数据库性能。

为了解决这个问题，PolarDB采用了基于提交时间戳的MVCC，以获得更好的扩展性能。具体而言，在每个事务开始和提交时，会生成一个开始时间戳和提交时间戳。时间戳单调递增，以保持事务的隔离顺序。

PolarDB提供一个Commit Timestamp Store（CTS），用于存储提交时间戳和事务状态。因此，CTS的设计就已包含可扩展性。由于处于关键路径，PolarDB采用了并发数据结构和无锁算法来实现CTS，以避免在多核机器上出现扩展瓶颈。PolarDB在访问内存中的CTS缓冲区时，尽可能避免获取排他锁。仅当发生最近最少使用（LRU）替换时，才需要排他锁定。为了并行化LRU缓冲区替换和刷新，CTS采用多LRU分区结构实现多核架构。

由于放弃了基于XID的快照以获得更好的性能，PolarDB实现了基于CTS的vacuum、hot-chain裁剪和逻辑复制等。此外，通过使用CTS，PolarDB简化了逻辑复制的快照构建过程。PostgreSQL中的原始逻辑复制包括四个步骤。这些步骤很复杂且难理解，很难推理其正确性。相比之下，基于CTS的快照构建仅需两个步骤，并且比原始的PostgreSQL逻辑复制步骤更容易理解。

PolarDB使用混合逻辑时钟（HLC）为事务生成开始时间戳和提交时间戳，以保持快照隔离。快照隔离级别支持可重复读（RR）和读提交（RC）隔离。在即将推出的分布式Shared-Nothing PolarDB中采用HLC，是为了支持去中心化的分布式事务管理。HLC由逻辑部分和物理部分组成。HLC的逻辑部分是一个严格递增计数器。逻辑部分用于跟踪事务顺序以确保快照隔离，而物理部分用于跨机器生成新鲜快照（freshness snapshots）。可以通过网络时间协议（NTP）或精确时间协议（PTP）同步每个节点上的物理时钟。局域网内的PTP可以将任何两台机器之间的最大时钟偏差保持在几微秒以内。在单个数据中心中，采用高级PTP可以使PolarDB像Google Spanner一样，在不同的节点之间提供外部强一致性。但是，即将推出的开源分布式版本基于NTP同步，仅旨在确保快照隔离和节点间的内部一致性。64位HLC时间戳由16个最低位逻辑计数器、48个较高位物理时间和2个保留位组成。

为了保持分布式快照隔离，PolarDB采用HLC为每个事务生成快照开始时间戳。任何节点在接受事务时，自动成为事务协调器节点，负责为该事务分配开始时间戳和提交时间戳。为了提交分布式事务，事务协调器通过两阶段提交协议（2PC），在准备阶段从所有参与节点收集准备好的HLC时间戳，并从所有准备好的时间戳中选取最大时间戳来确定事务的提交时间戳。最后，将提交时间戳传递给所有参与节点以提交事务。当一个事务访问某个节点（例如事务开始或提交）时，这个节点上的混合逻辑时钟会使用事务到达的开始时间戳和提交时间戳进行更新。PolarDB使用2PC的准备等待机制（类似于Google Percolator）来处理事务之间的因果关系排序。即，在验证写入的可见性时，MVCC扫描必须等待一个准备好的事务完成。事务的准备好状态保存在CTS中，以便快速访问。在已准备好的事务提交时，准备好状态会被替换为提交时间戳。分布式Shared-Nothing PolarDB即将提供基于HLC的分布式事务能力。PolarDB的主要设计目标是在每台多核机器上和跨机器实现可扩展的联机事务处理（OLTP）能力。

___

 © 阿里巴巴集团控股有限公司 版权所有

